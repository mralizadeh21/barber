<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ø±Ø§ÛŒØ´Ú¯Ø±</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container barber-section">
    <h1>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ø±Ø§ÛŒØ´Ú¯Ø§Ù‡</h1>
    <button class="btn-refresh" onclick="loadAppointments()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>

    <div class="filter-section">
         <label for="filterDate">Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® (Ù…Ø«Ø§Ù„: Û±Û´Û°Û³/Û°Û³/Û°Ûµ):</label>
         <input type="text" id="filterDate" placeholder="YYYY/MM/DD ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡">
         <button onclick="loadAppointments()">ÙÛŒÙ„ØªØ±</button>
    </div>

    <h2>Ù„ÛŒØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¨Øª</h2>
    <div id="barberMessage"></div>
    <table>
        <thead>
            <tr>
                <th>Ù†Ø§Ù…</th>
                <th>ØªÙ„ÙÙ†</th>
                <th>Ø®Ø¯Ù…Ø§Øª</th>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>Ø²Ù…Ø§Ù†</th>
                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                <th>Ø§Ù‚Ø¯Ø§Ù…Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="appointmentsTable">
            <tr><td colspan="7">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
        </tbody>
    </table>
</div>

<script>
    function loadAppointments() {
        const filterDateInput = document.getElementById('filterDate');
        const filterDate = filterDateInput ? filterDateInput.value : '';
        const tableBody = document.getElementById('appointmentsTable');
        const messageDiv = document.getElementById('barberMessage');

        if (!tableBody || !messageDiv) return;

        tableBody.innerHTML = '<tr><td colspan="7">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>';
        messageDiv.innerHTML = '';

        fetch(`api.php?action=get_appointments&date=${filterDate}`)
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = '';
                if (data.success && data.appointments.length > 0) {
                    data.appointments.forEach(app => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Ù†Ø§Ù…">${app.first_name} ${app.last_name}</td>
                            <td data-label="ØªÙ„ÙÙ†">${app.phone}</td>
                            <td data-label="Ø®Ø¯Ù…Ø§Øª">${app.service}</td>
                            <td data-label="ØªØ§Ø±ÛŒØ®">${app.app_date}</td>
                            <td data-label="Ø²Ù…Ø§Ù†">${app.app_time}</td>
                            <td data-label="ÙˆØ¶Ø¹ÛŒØª"><span class="${app.status}">${getStatusText(app.status)}</span></td>
                            <td data-label="Ø§Ù‚Ø¯Ø§Ù…Ø§Øª" class="actions">
                                ${app.status === 'pending' ? `
                                    <button class="btn-confirm" onclick="updateStatus(${app.id}, 'confirmed')">ØªØ§ÛŒÛŒØ¯</button>
                                    <button class="btn-reject" onclick="updateStatus(${app.id}, 'rejected')">Ø±Ø¯</button>
                                ` : (app.status === 'confirmed' ? 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡' : 'Ø±Ø¯ Ø´Ø¯Ù‡')}
                                 <button onclick="promptMessage(${app.id})">Ù¾ÛŒØ§Ù…</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else if (data.success) {
                     tableBody.innerHTML = '<tr><td colspan="7">Ù‡ÛŒÚ† Ù†ÙˆØ¨ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
                } else {
                    tableBody.innerHTML = `<tr><td colspan="7">Ø®Ø·Ø§: ${data.message || 'Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                tableBody.innerHTML = '<tr><td colspan="7">Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§.</td></tr>';
            });
    }

    function getStatusText(status) {
        switch (status) {
            case 'pending': return 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
            case 'confirmed': return 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡';
            case 'rejected': return 'Ø±Ø¯ Ø´Ø¯Ù‡';
            default: return status;
        }
    }

    function updateStatus(id, newStatus) {
        const messageDiv = document.getElementById('barberMessage');
        messageDiv.innerHTML = '';
        fetch('api.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update_status', id: id, status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            messageDiv.className = data.success ? 'success' : 'error';
            messageDiv.textContent = data.message;
            loadAppointments();
        })
        .catch(error => {
             console.error('Error:', error);
             messageDiv.className = 'error';
             messageDiv.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡.';
        });
    }

    function promptMessage(id) {
        const barberMsg = prompt("Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):");
        if (barberMsg !== null) {
            const messageDiv = document.getElementById('barberMessage');
            messageDiv.innerHTML = '';
            fetch('api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'send_message', id: id, barber_message: barberMsg })
            })
            .then(response => response.json())
            .then(data => {
                 messageDiv.className = data.success ? 'success' : 'error';
                 messageDiv.textContent = data.message;
            })
            .catch(error => {
                 console.error('Error:', error);
                 messageDiv.className = 'error';
                 messageDiv.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡.';
            });
        }
    }

    document.addEventListener('DOMContentLoaded', loadAppointments);
</script>

</body>
</html>